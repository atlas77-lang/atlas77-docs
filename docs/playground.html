<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Atlas 77 Playground</title>
    <meta name="description" content="Try Atlas 77 in your browser - an interactive playground for the Atlas 77 programming language." />
    <link rel="icon" href="logo.png" />
    <style>
      :root{
        --bg:#f7f9fb;
        --card:#ffffff;
        --accent:#e07a5f;
        --muted:#4b5563;
        --dark-bg:#1e1e1e;
        --editor-bg:#0b1220;
        --output-bg:#0f1419;
        --border:#e5e7eb;
        --success:#10b981;
        --error:#ef4444;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body{
        margin:0;
        font-family: Inter,Segoe UI,Roboto,system-ui,Arial;
        background:var(--bg);
        color:var(--muted);
        -webkit-font-smoothing:antialiased;
        height:100vh;
        display:flex;
        flex-direction:column;
      }
      .header{
        background:var(--card);
        border-bottom:1px solid var(--border);
        padding:1rem 2rem;
        display:flex;
        justify-content:space-between;
        align-items:center;
        box-shadow:0 2px 4px rgba(0,0,0,0.05);
      }
      .brand{display:flex;align-items:center;gap:12px}
      .brand img{height:32px}
      .brand h1{font-size:1.25rem;color:#1f2937}
      .nav-links{display:flex;gap:16px;align-items:center}
      .nav-links a{
        color:var(--muted);
        text-decoration:none;
        font-weight:500;
        transition:color 0.2s;
      }
      .nav-links a:hover{color:var(--accent)}
      .btn{
        display:inline-block;
        padding:8px 16px;
        border-radius:6px;
        text-decoration:none;
        font-weight:600;
        cursor:pointer;
        border:none;
        transition:all 0.2s;
      }
      .btn:disabled{
        opacity:0.6;
        cursor:not-allowed;
      }
      .btn-primary{
        background:var(--accent);
        color:#fff;
      }
      .btn-primary:hover:not(:disabled){
        background:#c96a4d;
      }
      .btn-secondary{
        background:transparent;
        border:1px solid var(--border);
        color:var(--muted);
      }
      .btn-secondary:hover:not(:disabled){
        background:var(--border);
      }
      .btn-success{
        background:var(--success);
        color:#fff;
      }
      .btn-success:hover:not(:disabled){
        background:#059669;
      }
      .playground-container{
        flex:1;
        display:flex;
        overflow:hidden;
      }
      .editor-panel{
        flex:1;
        display:flex;
        flex-direction:column;
        border-right:1px solid var(--border);
      }
      .toolbar{
        background:var(--card);
        border-bottom:1px solid var(--border);
        padding:0.75rem 1rem;
        display:flex;
        justify-content:space-between;
        align-items:center;
      }
      .toolbar-left{display:flex;gap:8px;align-items:center}
      .toolbar-right{display:flex;gap:8px;align-items:center}
      .status{
        font-size:0.875rem;
        color:var(--muted);
        display:flex;
        align-items:center;
        gap:6px;
      }
      .status.success{color:var(--success)}
      .status.error{color:var(--error)}
      .status.running{color:#3b82f6}
      .status-dot{
        width:8px;
        height:8px;
        border-radius:50%;
        background:currentColor;
        animation:pulse 1.5s ease-in-out infinite;
      }
      @keyframes pulse{
        0%, 100%{opacity:1}
        50%{opacity:0.5}
      }
      .editor{
        flex:1;
        background:var(--editor-bg);
        padding:1rem;
        overflow:auto;
        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,'Cascadia Code',monospace;
        font-size:14px;
        line-height:1.6;
        color:#dff3ff;
        resize:none;
        border:none;
        outline:none;
      }
      .output-panel{
        width:40%;
        display:flex;
        flex-direction:column;
        background:var(--dark-bg);
      }
      .output-toolbar{
        background:#2a2a2a;
        border-bottom:1px solid #3a3a3a;
        padding:0.75rem 1rem;
        display:flex;
        justify-content:space-between;
        align-items:center;
      }
      .output-title{
        font-weight:600;
        color:#e0e0e0;
        font-size:0.875rem;
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      .output{
        flex:1;
        background:var(--output-bg);
        padding:1rem;
        overflow:auto;
        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,'Cascadia Code',monospace;
        font-size:13px;
        line-height:1.6;
        color:#c9d1d9;
      }
      .output pre{margin:0.5rem 0;white-space:pre-wrap;word-wrap:break-word}
      .output .error{color:#ff7b72}
      .output .success{color:#7ee787}
      .output .info{color:#79c0ff}
      .coming-soon-banner{
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:#fff;
        padding:1rem;
        text-align:center;
        font-weight:500;
        box-shadow:0 2px 8px rgba(102,126,234,0.3);
      }
      select{
        padding:6px 12px;
        border:1px solid var(--border);
        border-radius:4px;
        background:var(--card);
        color:var(--muted);
        font-size:0.875rem;
        cursor:pointer;
      }
      #loading-overlay{
        position:fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.8);
        display:flex;
        align-items:center;
        justify-content:center;
        color:white;
        z-index:9999;
        font-size:1.2rem;
      }
      #loading-overlay.hidden{
        display:none;
      }
      @media(max-width:768px){
        .playground-container{flex-direction:column}
        .editor-panel{border-right:none;border-bottom:1px solid var(--border)}
        .output-panel{width:100%;height:300px}
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
      <div style="text-align:center">
        <div>Loading Atlas 77 Compiler...</div>
        <div style="font-size:0.9rem;margin-top:0.5rem;opacity:0.7">
          This may take a few seconds on first load
        </div>
      </div>
    </div>

    <!-- Coming Soon Banner -->
    <div class="coming-soon-banner">
      üöÄ Playground is coming soon! WASM compilation in progress.
    </div>
    
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <img src="logo.png" alt="Atlas 77" onerror="this.style.display='none'"/>
        <h1>Atlas 77 Playground</h1>
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="docs/latest/index.html">Docs</a>
        <a href="https://github.com/atlas77-lang/Atlas77" target="_blank" rel="noopener">GitHub</a>
      </div>
    </div>

    <!-- Main Playground -->
    <div class="playground-container">
      <!-- Editor Panel (Left) -->
      <div class="editor-panel">
        <div class="toolbar">
          <div class="toolbar-left">
            <select id="example-select">
              <option value="">Select an example...</option>
              <option value="hello">Hello World</option>
              <option value="variables">Variables</option>
              <option value="functions">Functions</option>
              <option value="loops">Loops</option>
              <option value="io">File I/O</option>
            </select>
          </div>
          <div class="toolbar-right">
            <span class="status" id="status">
              <span class="status-dot"></span>
              Loading...
            </span>
            <button class="btn btn-success" id="run-btn" onclick="window.runCode()" disabled>
              ‚ñ∂ Run
            </button>
          </div>
        </div>
        <textarea class="editor" id="editor" spellcheck="false" placeholder="// Write your Atlas 77 code here...">import std/io;

fun main() {
  println("Hello, Atlas 77!");
}</textarea>
      </div>

      <!-- Output Panel (Right) -->
      <div class="output-panel">
        <div class="output-toolbar">
          <div class="output-title">Output</div>
          <button class="btn btn-secondary" id="clear-btn" onclick="window.clearOutput()" style="font-size:0.75rem;padding:4px 8px">Clear</button>
        </div>
        <div class="output" id="output">
          <pre class="info">Waiting for compiler to load...</pre>
        </div>
      </div>
    </div>

    <!-- ============================================
         MAIN WASM INTEGRATION (Module Script)
         ============================================ -->
    <script type="module">
      // Import WASM functions
      import init, { compile_and_run, get_version } from './playground/pkg/atlas77_wasm.js';

      // Global state
      let wasmReady = false;

      // ============================================
      // Initialize WASM module on page load
      // ============================================
      async function initWasm() {
        try {
          // Initialize the WASM module
          await init();
          wasmReady = true;
          
          // Get version
          const version = get_version();
          console.log(`‚úì Atlas 77 WASM module loaded (v${version})`);
          
          // Update status
          window.setStatus('success', `Ready (v${version})`);
          
          // Enable run button
          document.getElementById('run-btn').disabled = false;
          
          // Hide loading overlay
          document.getElementById('loading-overlay').classList.add('hidden');
          
        } catch (err) {
          console.error('‚ùå Failed to load WASM:', err);
          window.setStatus('error', 'Failed to load compiler');
          window.appendOutput('<span class="error">Error: Failed to load Atlas 77 compiler</span>');
          window.appendOutput('<span class="error">Details: ' + err.message + '</span>');
        }
      }

      // Start initialization
      initWasm();

      // ============================================
      // Code Execution Function
      // ============================================
      window.runCode = async function() {
        if (!wasmReady) {
          window.appendOutput('<span class="error">Error: Compiler still loading...</span>');
          return;
        }

        const code = document.getElementById('editor').value.trim();
        if (!code) {
          window.appendOutput('<span class="error">Error: No code to execute</span>');
          return;
        }

        // Clear previous output
        window.clearOutput();
        
        // Show running status
        window.setStatus('running', 'Compiling...');
        document.getElementById('run-btn').disabled = true;

        try {
          // Call WASM compile_and_run
          const result = compile_and_run(code);
          
          if (result.success) {
            window.appendOutput('<span class="success">‚úì Compilation successful!</span>');
            window.appendOutput('<span class="info">--- Program Output ---</span>');
            
            if (result.stdout) {
              window.appendOutput(result.stdout);
            } else {
              window.appendOutput('<span class="info">(No output)</span>');
            }
            
            if (result.stderr) {
              window.appendOutput('<span class="error">--- Stderr ---</span>');
              window.appendOutput('<span class="error">' + result.stderr + '</span>');
            }
            
            window.setStatus('success', 'Executed successfully');
          } else {
            // Compilation error
            window.appendOutput('<span class="error">‚ùå Compilation Error</span>');
            window.appendOutput('<span class="error">' + result.stderr + '</span>');
            window.setStatus('error', 'Compilation failed');
          }
        } catch (err) {
          // Runtime error
          console.error('Execution error:', err);
          window.appendOutput('<span class="error">‚ùå Fatal Error</span>');
          window.appendOutput('<span class="error">Error: ' + err.message + '</span>');
          window.setStatus('error', 'Execution failed');
        } finally {
          document.getElementById('run-btn').disabled = false;
        }
      };
    </script>

    <!-- ============================================
         UI HELPER FUNCTIONS (Regular Script)
         ============================================ -->
    <script>
      // Example code snippets
      const examples = {
        hello: `import std/io;

fun main() {
  println("Hello, Atlas 77!");
}`,
        variables: `import std/io;

fun main() {
  let name: string = "Atlas";
  let version: int64 = 7;
  println("Welcome to Atlas 77!");
}`,
        functions: `import std/io;

fun add(a: int64, b: int64) -> int64 {
  return a + b;
}

fun main() {
  let result: int64 = add(5, 7);
  println(result);
}`,
        loops: `import std/io;

fun main() {
  let i: int64 = 0;
  while i < 5 {
    println("Iteration!");
    i = i + 1;
  }
}`,
        io: `import std/fs;
import std/io;

fun main() {
  let content: string = "Hello, file!";
  write_file("data.txt", content);
  println("File written!");
}`
      };

      // ============================================
      // Append text to output panel
      // ============================================
      window.appendOutput = function(text) {
        const output = document.getElementById('output');
        const pre = document.createElement('pre');
        pre.innerHTML = window.sanitizeOutput(text);
        output.appendChild(pre);
        output.scrollTop = output.scrollHeight;
      };

      // ============================================
      // Clear the output panel
      // ============================================
      window.clearOutput = function() {
        document.getElementById('output').innerHTML = '';
      };

      // ============================================
      // Update the status indicator
      // ============================================
      window.setStatus = function(type, message) {
        const status = document.getElementById('status');
        status.className = `status ${type}`;
        status.innerHTML = `<span class="status-dot"></span>${message}`;
      };

      // ============================================
      // Sanitize text for safe HTML display
      // ============================================
      window.sanitizeOutput = function(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      };

      // ============================================
      // Example selector change handler
      // ============================================
      document.getElementById('example-select').addEventListener('change', (e) => {
        const example = examples[e.target.value];
        if (example) {
          document.getElementById('editor').value = example;
        }
      });

      // ============================================
      // Keyboard shortcut: Ctrl+Enter to run
      // ============================================
      document.getElementById('editor').addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          window.runCode();
        }
      });

      // ============================================
      // Tab key support in editor
      // ============================================
      document.getElementById('editor').addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const editor = document.getElementById('editor');
          const start = editor.selectionStart;
          const end = editor.selectionEnd;
          editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
          editor.selectionStart = editor.selectionEnd = start + 2;
        }
      });
    </script>
  </body>
</html>
